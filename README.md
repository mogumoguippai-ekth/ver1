# 私の望む暮らしアプリケーション (IWLM App)

## 概要
「私の望む暮らし」アプリケーションは、ユーザーの個人情報、生活習慣、希望を記録・分析し、Google Gemini AIを使用して個人化された長期目標と短期目標を提案するWebアプリケーションです。本人ユーザーと家族ユーザーの2種類のユーザータイプに対応しています。

## 主な機能

### 1. ユーザー管理
- **本人ユーザー登録・ログイン**
- **家族ユーザー登録・ログイン**（招待コード制）
- 基本情報管理（氏名、生年月日、性別など）
- 招待コード生成・管理機能

### 2. プロフィール管理
- 詳細な個人情報の登録・編集
- 家族構成、住居状況、興味関心の記録
- プロフィール一覧表示・印刷機能
- **家族ユーザーは閲覧のみ**（編集・削除不可）

### 3. 私の暮らし管理
- 日常生活の詳細記録（食事、睡眠、趣味など）
- 生活習慣、嗜好、希望・不安の記録
- 暮らし情報一覧表示・印刷機能
- **家族ユーザーは閲覧のみ**（編集・削除不可）

### 4. ダイアリー機能
- カレンダー形式での日記記録
- **写真アップロード機能**（位置情報自動削除・リサイズ・サムネイル作成）
- 日記一覧表示
- **家族ユーザー専用カレンダー表示**（日付クリックで日記一覧へ移動）
- 写真削除機能

### 5. AI目標提案機能
- **Google Gemini AI**を使用した個人化された目標提案
- 長期目標（3年後）と短期目標（3つ）の自動生成
- 目標履歴管理
- **情報更新時の自動目標更新**（データ変更がない場合はAI実行しない）
- **家族ユーザーは閲覧のみ**（AI実行・更新不可）

## 必要な環境

### システム要件
- Python 3.8以上
- Windows 10/11 または Linux/macOS
- 4GB以上のRAM
- 1GB以上の空きディスク容量
- **Google Gemini API キー**（AI目標生成機能用）

### 必要なライブラリ
```
Flask==2.3.3
Pillow==10.0.1
google-generativeai==0.8.5
python-dotenv==1.1.1
requests==2.32.5
```

## インストール手順

### 1. リポジトリのクローン
```bash
git clone <repository-url>
cd iwlm_app/ver1
```

### 2. 仮想環境の作成（推奨）
```bash
# Windows
python -m venv .venv
.venv\Scripts\activate

# Linux/macOS
python3 -m venv .venv
source .venv/bin/activate
```

### 3. 必要なライブラリのインストール
```bash
pip install Flask==2.3.3
pip install Pillow==10.0.1
pip install google-generativeai==0.8.5
pip install python-dotenv==1.1.1
pip install requests==2.32.5
```

### 4. Google Gemini API キーの設定
1. [Google AI Studio](https://aistudio.google.com/)でAPIキーを取得
2. プロジェクトルートに`.env`ファイルを作成
3. 以下の内容を記述：
```
GOOGLE_API_KEY=your_api_key_here
```

### 5. データベースの初期化
```bash
python -c "from config import db; db.init_db()"
```

## 起動方法

### 1. アプリケーションの起動
```bash
python app.py
```

### 2. ブラウザでアクセス
```
http://localhost:5000
```

## 使用方法

### 本人ユーザーの場合

#### 1. ユーザー登録
- 初回アクセス時にユーザーID、パスワード、基本情報を入力
- ログイン後はダッシュボードにアクセス

#### 2. 家族ユーザー招待
- ユーザーページで招待コードを生成
- 家族メンバーに招待コードを共有

#### 3. プロフィール登録
- ヘッダーメニュー「私について」→「登録」
- 詳細な個人情報を入力
- 「更新」ボタンで保存

#### 4. 暮らし情報登録
- ヘッダーメニュー「私の暮らし」→「登録」
- 日常生活の詳細情報を入力
- チェックボックス形式での選択項目
- 「その他」項目では自由記述可能

#### 5. ダイアリー記録
- ヘッダーメニュー「ダイアリー」→「登録」
- カレンダーから日付を選択
- 日記タイトル、本文（200文字以内）、写真（1枚）を記録
- **写真の位置情報は自動削除されます**

#### 6. AI目標提案の確認
- ヘッダーメニュー「目標提案」
- **Google Gemini AI**が自動生成した長期・短期目標を確認
- 情報更新時は更新確認アラートが表示

### 家族ユーザーの場合

#### 1. 家族ユーザー登録
- 本人ユーザーから受け取った招待コードを使用して登録
- ユーザーID、パスワード、基本情報を入力

#### 2. 閲覧機能
- **すべての機能が閲覧・印刷のみ**
- 編集・削除・新規作成はできません

#### 3. ダイアリー閲覧
- ヘッダーメニュー「ダイアリー」→「カレンダー」
- カレンダーで日付をクリックすると日記一覧ページに移動
- 日記の内容と写真を閲覧可能

#### 4. 目標提案閲覧
- ヘッダーメニュー「目標提案」→「目標提案」
- 本人ユーザーの目標を閲覧可能
- AI目標生成は実行されません

## ファイル構成

```
iwlm_app/ver1/
├── app.py                 # Flaskアプリケーションのメイン
├── config.py              # データベース設定・操作
├── ai_goal_service.py     # Google Gemini AI目標生成サービス
├── db.sqlite             # SQLiteデータベース
├── .env                  # 環境変数（Google API キー）
├── static/
│   ├── style.css         # CSSスタイル
│   ├── images/           # 画像ファイル
│   ├── js/
│   │   └── app.js        # JavaScript（カレンダー、モーダル等）
│   └── uploads/
│       ├── diary_photos/  # ダイアリー登録画像ファイル
│       └── diary_thumbnails/  # ダイアリー登録画像のサムネイルファイル
├── templates/            # HTMLテンプレート
│   ├── base.html         # ベーステンプレート（ユーザータイプ別メニュー）
│   ├── index.html        # ログインページ
│   ├── dashboard.html    # ダッシュボード
│   ├── user.html         # ユーザー基本情報登録・家族管理
│   ├── profile.html      # 私について 詳細情報登録
│   ├── profile_table.html # 私について 一覧
│   ├── iwlm.html         # 私の暮らし 情報登録
│   ├── iwlm_table.html   # 私の暮らし 情報一覧
│   ├── diary_calender.html # ダイアリー登録・カレンダー表示
│   ├── diary_list.html   # ダイアリー一覧
│   ├── goals.html        # AI目標提案
│   └── goals_history.html # 目標提案履歴管理
└── README.md             # このファイル
```

## データベース構造

### users テーブル
- ユーザー基本情報（ID、パスワード、氏名、生年月日など）
- 家族ID管理（family_id1-3）

### family_users テーブル
- 家族ユーザー情報（family_user_id、parent_user_id、パスワードなど）
- 本人ユーザーとの関連付け

### invitation_codes テーブル
- 招待コード管理（code、user_id、expiry_date、used）
- 家族ユーザー登録用の一時的なコード

### profiles テーブル
- 詳細プロフィール情報（住所、家族構成、興味関心など）

### iwlm テーブル
- 暮らし情報（食事、睡眠、趣味、希望・不安など）

### diary テーブル
- 日記データ（日付、タイトル、本文、写真パス、サムネイルパス）
- 位置情報削除済み画像の保存

### user_goals テーブル
- AI目標提案履歴（長期目標、短期目標、作成日時）
- データ変更追跡用のタイムスタンプ管理

## 印刷機能

各一覧ページで印刷機能が利用可能：
- プロフィール一覧の印刷
- 暮らし情報一覧の印刷
- 目標提案の印刷
- A4サイズに最適化されたレイアウト

## トラブルシューティング

### よくある問題

#### 1. アプリケーションが起動しない
```bash
# 必要なライブラリがインストールされているか確認
pip list | grep Flask
pip list | grep Pillow
pip list | grep google-generativeai
```

#### 2. Google Gemini API エラー
- `.env`ファイルにAPIキーが正しく設定されているか確認
- APIキーが有効で、使用制限に達していないか確認
- [Google AI Studio](https://aistudio.google.com/)で使用状況を確認

#### 3. データベースエラー
```bash
# データベースファイルを削除して再初期化
rm db.sqlite
python -c "from config import db; db.init_db()"
```

#### 4. 画像アップロードエラー
- アップロードする画像のファイルサイズを確認
- 対応形式：JPEG、PNG、GIF
- 位置情報削除処理でエラーが発生する場合がある

#### 5. 目標提案が表示されない
- プロフィールまたは暮らし情報が登録されているか確認
- Google Gemini APIキーが正しく設定されているか確認
- データベースの目標テーブルが正しく作成されているか確認

#### 6. 家族ユーザー関連の問題
- 招待コードが有効期限内か確認
- 家族ユーザーが正しく本人ユーザーと関連付けられているか確認

## 開発者向け情報

### カスタマイズ
- AI目標生成ロジック：`ai_goal_service.py`の`AIGoalService`クラス
- データベース操作：`config.py`の各種メソッド
- スタイル変更：`static/style.css`
- テンプレート変更：`templates/`ディレクトリ内のHTMLファイル
- ユーザータイプ別制御：`app.py`の`@self_user_required`デコレーター

### セキュリティ機能
- **パスワードハッシュ化**：Werkzeugの`generate_password_hash`を使用
- **写真の位置情報削除**：Pillowを使用したEXIFデータの自動削除
- **アクセス制御**：ユーザータイプ別の機能制限
- **招待コード制**：家族ユーザー登録時のセキュリティ

### 将来の拡張予定
- データエクスポート機能
- モバイル対応
- より詳細な権限管理
- バックアップ・復元機能

## ライセンス
このプロジェクトはMITライセンスの下で公開されています。

## サポート
問題が発生した場合は、以下の手順でサポートを受けてください：

1. このREADMEのトラブルシューティングセクションを確認
2. エラーメッセージと発生状況を記録
3. GitHubのIssuesで問題を報告

## 更新履歴

### v1.1.0 (2025年10月)
- **Google Gemini AI**による目標提案機能を実装
- **家族ユーザー機能**を追加（招待コード制）
- **写真の位置情報自動削除**機能を追加
- **ユーザータイプ別アクセス制御**を実装
- **日記カレンダーの表示改善**（タイトル表示、家族ユーザー専用表示）
- **写真削除機能**を追加
- **データ変更検知によるAI実行制御**を実装
- **プライバシー保護機能**の強化

### v1.0.0 (2025年)
- 初期リリース
- 基本機能の実装
- ユーザー管理、プロフィール、暮らし情報、ダイアリー機能
- 目標提案機能（固定ロジック）
- 印刷機能

---

**注意**: このアプリケーションは個人情報を扱います。適切なセキュリティ対策を行い、本番環境での使用時はHTTPS化やアクセス制限を実装してください。
