{% extends "base.html" %}

{% block title %}私について 基本情報編集 - 私の望む暮らし{% endblock %}

{% block page_title %}私について 基本情報編集{% endblock %}

{% block nickname %}{{ session.get('nickname', 'ゲスト') }}{% endblock %}

{% block content %}
<div class="user-registration">
    <h2>私について 基本情報編集</h2>

    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <div class="alert alert-success">
        {{ messages[0] }}
    </div>
    {% endif %}
    {% endwith %}

    <!-- デバッグ情報（一時的）
    <div class="invitation-info">
        <strong>デバッグ情報:</strong><br>
        ユーザータイプ: {{ session.get('user_type') }}<br>
        ユーザーID: {{ session.get('user_id') }}<br>
        親ユーザーID: {{ session.get('parent_user_id') }}<br>
        family_living: {{ user[13] if user and user[13] else 'NULL' }}<br>
        updated_at: {{ user[15] if user and user[15] else 'NULL' }}
    </div> -->
    <!-- 招待コード発行セクション（本人ユーザーのみ） -->
    {% if session.get('user_type') == 'self' %}
    <div class="invitation-section">
        <h3>家族招待</h3>
        <p>家族に招待コードを発行して、家族会員として登録してもらえます。</p>
        <button type="button" id="generate-invitation-btn" class="invitation-btn">招待コードを発行</button>

        <!-- 招待コード表示エリア -->
        <div id="invitation-code-display" class="invitation-code-display">
            <h4>招待コード</h4>
            <div class="code-container">
                <span id="invitation-code-text" class="code-text"></span>
                <button type="button" id="copy-code-btn" class="copy-btn">コピー</button>
            </div>
            <p class="expires-text">有効期限: <span id="expires-at"></span></p>
            <p class="note-text">※このコードは30分間有効です</p>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        <strong>注意:</strong> 招待コード発行機能は本人ユーザーのみ利用できます。
        現在のユーザータイプ: {{ session.get('user_type', '未設定') }}
    </div>
    {% endif %}

    {% if session.get('user_type') == 'self' %}
    <form method="POST" action="{{ url_for('update_user') }}" class="registration-form">
        <!-- ユーザーID (表示のみ) -->
        <div class="form-group">
            <label for="user_id">ユーザーID</label><br>
            <input type="text" id="user_id" value="{{ user[1] if user else '' }}" disabled class="disabled-input">
        </div>

        <!-- メールアドレス (表示 + 訂正ボタン) -->
        <div class="form-group">
            <label for="email">メールアドレス</label><br>
            <div class="input-with-button">
                <input type="email" id="email" value="{{ user[2] if user else '' }}" disabled class="disabled-input">
                <button type="button" class="edit-btn" onclick="toggleEdit('email')">訂正</button>
            </div>
            <div id="email-edit" class="edit-section">
                <label for="new_email">訂正後</label>
                <input type="email" id="new_email" name="new_email" placeholder="新しいメールアドレスを入力">
            </div>
        </div>

        <!-- パスワード (表示 + 訂正ボタン) -->
        <div class="form-group">
            <label for="password">パスワード</label><br>
            <div class="input-with-button">
                <input type="password" id="password" value="********" disabled class="disabled-input">
                <button type="button" class="edit-btn" onclick="toggleEdit('password')">訂正</button>
            </div>
            <div id="password-edit" class="edit-section">
                <label for="new_password">訂正後</label>
                <input type="password" id="new_password" name="new_password" placeholder="新しいパスワードを入力">
            </div>
        </div>

        <!-- 氏名 -->
        <div class="form-group">
            <label for="name">氏名</label><br>
            <input type="text" id="name" name="name" value="{{ user[5] if user and user[5] else '' }}" placeholder="氏名を入力">
        </div>

        <!-- フリガナ -->
        <div class="form-group">
            <label for="furigana">フリガナ</label><br>
            <input type="text" id="furigana" name="furigana" value="{{ user[6] if user and user[6] else '' }}" placeholder="フリガナを入力">
        </div>

        <!-- ニックネーム -->
        <div class="form-group">
            <label for="nickname">ニックネーム</label><br>
            <input type="text" id="nickname" name="nickname" value="{{ user[7] if user and user[7] else '' }}" placeholder="表示名を入力">
        </div>

        <!-- 性別 -->
        <div class="form-group">
            <label for="gender">性別</label>
            <select id="gender" name="gender">
                <option value="">選択してください</option>
                <option value="男" {% if user and user[8]=='男' %}selected{% endif %}>男</option>
                <option value="女" {% if user and user[8]=='女' %}selected{% endif %}>女</option>
                <option value="その他" {% if user and user[8]=='その他' %}selected{% endif %}>その他</option>
            </select>
        </div>

        <!-- 生年月日 -->
        <div class="form-group">
            <label for="birth_date">生年月日</label>
            <input type="date" id="birth_date" name="birth_date" value="{{ user[9] if user and user[9] else '' }}">
        </div>

        <!-- 家族情報 -->
        <div class="family-section">
            <h3 class="section-title">家族情報</h3>
            {% if family_users %}
            {% for i in range(3) %}
            <div class="form-group">
                <label for="family_id{{ i + 1 }}">家族ID{{ i + 1 }}</label>
                <div class="family-id-container">
                    <input type="text" id="family_id{{ i + 1 }}" name="family_id{{ i + 1 }}" value="{{ family_users[i][1] if i < family_users|length else '' }}" placeholder="家族ID{{ i + 1 }}" readonly class="family-id-input">
                    {% if i < family_users|length %} <button type="button" class="delete-family-btn" onclick="deleteFamilyUser('{{ family_users[i][1] }}', {{ i + 1 }})" title="家族ユーザーを削除">×</button>
                        {% endif %}
                </div>
            </div>
            {% endfor %}
            {% else %}
            <!-- 家族ユーザーが登録されていない場合 -->
            <div class="form-group">
                <label for="family_id1">家族ID1</label>
                <input type="text" id="family_id1" name="family_id1" value="" placeholder="家族ID1" readonly>
            </div>
            <div class="form-group">
                <label for="family_id2">家族ID2</label>
                <input type="text" id="family_id2" name="family_id2" value="" placeholder="家族ID2" readonly>
            </div>
            <div class="form-group">
                <label for="family_id3">家族ID3</label>
                <input type="text" id="family_id3" name="family_id3" value="" placeholder="家族ID3" readonly>
            </div>
            {% endif %}
        </div>

        <!-- ボタン -->
        <div class="form-actions">
            <button type="submit" class="submit-btn">更新する</button>
            <button type="button" class="cancel-btn" onclick="window.location.href='{{ url_for('dashboard') }}'">キャンセル</button>
        </div>
    </form>
    {% else %}
    <!-- 家族ユーザー用：閲覧専用表示 -->
    <div class="view-only-form">
        <div class="form-group">
            <label>ユーザーID</label><br>
            <div class="readonly-value">{{ user[1] if user else '' }}</div>
        </div>

        <div class="form-group">
            <label>メールアドレス</label><br>
            <div class="readonly-value">{{ user[2] if user else '' }}</div>
        </div>

        <div class="form-group">
            <label>氏名</label><br>
            <div class="readonly-value">{{ user[5] if user and user[5] else '未入力' }}</div>
        </div>

        <div class="form-group">
            <label>フリガナ</label><br>
            <div class="readonly-value">{{ user[6] if user and user[6] else '未入力' }}</div>
        </div>

        <div class="form-group">
            <label>ニックネーム</label><br>
            <div class="readonly-value">{{ user[7] if user and user[7] else '未入力' }}</div>
        </div>

        <div class="form-group">
            <label>性別</label><br>
            <div class="readonly-value">{{ user[8] if user and user[8] else '未入力' }}</div>
        </div>

        <div class="form-group">
            <label>生年月日</label><br>
            <div class="readonly-value">{{ user[9] if user and user[9] else '未入力' }}</div>
        </div>

        <div class="family-section">
            <h3 class="section-title">家族情報</h3>
            {% if session.get('user_type') == 'family' %}
            <!-- 家族ユーザーの場合：自分の家族IDを表示 -->
            <div class="form-group">
                <label>家族ID</label><br>
                <div class="readonly-value">{{ family_user[1] if family_user else '未設定' }}</div>
            </div>
            {% else %}
            <!-- 本人ユーザーの場合：family_usersテーブルから家族IDを表示 -->
            {% if family_users %}
            {% for i in range(3) %}
            <div class="form-group">
                <label>家族ID{{ i + 1 }}</label><br>
                <div class="readonly-value">{{ family_users[i][1] if i < family_users|length else '未設定' }}</div>
                </div>
                {% endfor %}
                {% else %}
                <!-- 家族ユーザーが登録されていない場合 -->
                <div class="form-group">
                    <label>家族ID1</label><br>
                    <div class="readonly-value">未設定</div>
                </div>
                <div class="form-group">
                    <label>家族ID2</label><br>
                    <div class="readonly-value">未設定</div>
                </div>
                <div class="form-group">
                    <label>家族ID3</label><br>
                    <div class="readonly-value">未設定</div>
                </div>
                {% endif %}
                {% endif %}
            </div>

            <div class="form-actions">
                <button type="button" class="cancel-btn" onclick="window.location.href='{{ url_for('dashboard') }}'">戻る</button>
            </div>
        </div>
        {% endif %}
    </div>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    {% endblock %}
