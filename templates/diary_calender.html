{% extends "base.html" %}

{% block title %}日記カレンダー - 私の望む暮らし{% endblock %}

{% block page_title %}日記カレンダー{% endblock %}

{% block nickname %}{{ session.get('nickname', 'ゲスト') }}{% endblock %}

{% block content %}
<div class="diary-calendar-page">
    <h2>日記カレンダー</h2>

    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <div class="alert alert-success">
        {{ messages[0] }}
    </div>
    {% endif %}
    {% endwith %}

    <div class="calendar-container">
        <div class="calendar-header">
            <button onclick="changeMonth(-1)" class="month-nav-btn">← 前月</button>
            <h3 id="current-month-year">{{ current_year }}年{{ current_month }}月</h3>
            <button onclick="changeMonth(1)" class="month-nav-btn">次月 →</button>
        </div>

        <div class="calendar-grid">
            <div class="calendar-weekdays">
                <div class="weekday">日</div>
                <div class="weekday">月</div>
                <div class="weekday">火</div>
                <div class="weekday">水</div>
                <div class="weekday">木</div>
                <div class="weekday">金</div>
                <div class="weekday">土</div>
            </div>
            <div class="calendar-days" id="calendar-days">
                <!-- JavaScriptで動的に生成 -->
            </div>
        </div>
    </div>

    <!-- 日記入力モーダル -->
    <div id="diary-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-date-title">日記を入力</h3>
                <span class="close" onclick="closeDiaryModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="diary-form" enctype="multipart/form-data">
                    <input type="hidden" id="selected-date" name="date">

                    <div class="form-group">
                        <label for="diary-title">タイトル</label>
                        <input type="text" id="diary-title" name="title" maxlength="50" placeholder="タイトルを入力してください">
                    </div>

                    <div class="form-group">
                        <label for="diary-content">日記本文（200文字以内）</label>
                        <textarea id="diary-content" name="content" maxlength="200" rows="4" placeholder="今日の出来事や感想を入力してください"></textarea>
                        <div class="char-count">
                            <span id="char-count">0</span>/200文字
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="diary-photo">写真（1点のみ）</label>
                        <input type="file" id="diary-photo" name="photo" accept="image/*" onchange="previewPhoto(this)">
                        <div id="photo-preview" class="photo-preview"></div>
                    </div>

                    <div class="existing-photo" id="existing-photo">
                        <h4>現在の写真</h4>
                        <img id="existing-photo-img" src="" alt="現在の写真">
                        {% if session.get('user_type') != 'family' %}
                        <button type="button" onclick="deletePhoto()" class="delete-photo-btn">写真を削除</button>
                        {% endif %}
                    </div>

                    <div class="modal-actions">
                        <button type="button" onclick="saveDiary()" class="save-btn">保存</button>
                        {% if session.get('user_type') != 'family' %}
                        <button type="button" onclick="deleteDiary()" class="delete-btn" id="delete-btn">削除</button>
                        {% endif %}
                        <button type="button" onclick="closeDiaryModal()" class="cancel-btn">キャンセル</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="calendar-actions">
        <a href="{{ url_for('diary_list') }}" class="list-btn">日記一覧 を見る</a>
        <a href="{{ url_for('dashboard') }}" class="back-btn">HOMEに戻る</a>
    </div>
</div>

<script src="{{ url_for('static', filename='js/app.js') }}"></script>
<script>
    // ユーザータイプを設定
    window.userType = '{{ session.get('user_type', 'self') }}';

    // 初期化データを設定
    document.addEventListener('DOMContentLoaded', function () {
        initDiaryCalendar({{ current_year }}, {{ current_month }}, {{ diary_entries | tojson }});
    });
</script>
{% endblock %}
